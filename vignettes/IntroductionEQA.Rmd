---
title: "Introduction to Ecological Quality Assessment (EQA)"
author: "Anthony Sturbois/Miquel De Cáceres"
date: "`r Sys.Date()`"
output: 
  rmarkdown::html_vignette:
    toc: TRUE
vignette: >
  %\VignetteIndexEntry{Introduction to Ecological Quality Assessment (EQA)}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignettePackage{ecotraj}
  \usepackage[utf8]{inputenc}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## 1. About this vignette

This vignette present the ecological applications used by Sturbois at al. (under review) in the presentation of the Ecological Quality Assessment (EQA) framework.
After the distance-matrix computation, the vignette focuses on Ecological Quality Assessement through state-based and trajectory-based variants, and on the representation of the results. 
Data sets used in this vignette have been included in the package for reproducibility.

## 2. Loading libraries

First of all, we load required libraries, including `ecotraj`:
```{r load libraries, echo = T}
#loading libraries
library(ecotraj)
library(vegan)
library(vegclust)
library(ape)
library(ggplot2)
library(reshape2)
```


## 3. Heathland conservation status in *Landes et Marais de Glomel*

### 3.1 Context
The nature reserve of *Landes et Marais de Glomel* (Brittany, France) is composed of temperate Atlantic wet heaths whose reference state is commonly considered dominated by plant communities associated to acid, nutrient poor soils that are at least seasonally water logged and dominated by *Erica tetralix* and *E. ciliaris*. This habitat is considered of community interest as part of the European directive on the conservation of natural habitats and of wild fauna and flora (97/62/CEE). For the definition of the reference envelope, surveys integrated the variability of reference states from youngest to early senescent stages, based on expert assessment with respect to the European Directive (97/62/CEE) requirements.

### 3.2 Loading data

The data set consists of 23 rows (stations) and 46 columns (species). The percent cover values derived from Braun-Blanquet ordinal scale was estimated for 43 species of vascular plants. The first five stations (rows) were used to define the reference envelope, and the next 18 stations (rows) where those for which the conservation status was to be assessed.

```{r load glomel, echo=T}
data(glomel)
#Showing a first lines /columns subset
head(glomel[,1:8])
```



### 3.3 Ecological Quality Assessment

We first create a compositional data matrix, by extracting species data from the initial data table:
```{r, echo=T}
glomel_comp <- as.matrix(glomel[,!(names(glomel) %in% c("ID", "Ref"))])
rownames(glomel_comp) <- glomel$ID 
dim(glomel_comp)
```

Using the compositional data, we can use function `vegdist()` from package **vegan** to calculate of Bray Curtis distances between ecosystem states:
```{r, echo=T}
glomel_bc <- vegan::vegdist(glomel_comp, method = "bray")
```

Column `Ref` identifies stations considered as reference. We define the **state reference envelope** using reference station IDs as follows:
```{r, echo=T}
glomel_env <- glomel$ID[glomel$Ref]
```

We are now ready to comparing the assessed stations with respect to the state reference envelope:
```{r, echo=T}
glomel_assess <- compareToStateEnvelope(glomel_bc, glomel_env, m=1.7, distances_to_envelope = TRUE)
head(glomel_assess)
```
Function `compareToStateEnvelope` returns the squared distance to the envelope centroid and values of Q statistic, between 0 and 1. We can transform those values into a qualitative assessement using:
```{r, echo=T}
glomel_assess$Status<-c(ifelse(glomel_assess$Q>=0.5,"Inside", "Oustside"))
head(glomel_assess)
```


### 3.4 Representing the results of Glomel EQSA

To represent the results in a graphical way, we start by conducting a Principal Coordinates Analysis (PCoA) using package **ape**:
```{r, echo=TRUE}
pcoa_glom<-ape::pcoa(glomel_bc)
pcoa_glom$values
```

We can use function `biplot()` from package **ape** to show the ordination of stations with the species projected as arrows:
```{r, echo=TRUE, fig.width=6, fig.height=6, warning = FALSE}
biplot(pcoa_glom, glomel_comp)
```

Get coordinates of stations in the two first dimensions of the PCoA and copy them into the assessment data frame:
```{r, echo=TRUE}
PCOA_DIM1_2 <- pcoa_glom[["vectors"]][,1:2]
glomel_assess$Dim1<-PCOA_DIM1_2[,1]
glomel_assess$Dim2<-PCOA_DIM1_2[,2]

head(glomel_assess)
```

We will use package **ggplot** to achieve a nicer representation of the assessment. Colors are used to illustrate stations that achieve conservation objectives (green) from those that not achieve them (red). The size of dot illustrate the squared distance to the centroid of the state reference envelope:

```{r, echo=TRUE, fig.width=6, fig.height=6}
p<-ggplot(glomel_assess,
          mapping=aes(x=Dim1,y=Dim2,size=SquaredDist, color=Status, shape=Status))+
  geom_point()+
  scale_colour_manual(values=c("#00BFC4", "#F8766D"))+
  geom_text(glomel_assess, 
            mapping=aes(x=Dim1,y=Dim2,label=Observation),
            hjust=-0.3, vjust=-0.3,size=2.5, color="Black")+
  xlab(expression("PCoA1 (27.7%)"))+
  ylab(expression("PCoA2 (13.7%)"))

p<-p + theme_minimal()+
  theme(
    # Hide some graphical elements
    panel.border = element_blank(),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    axis.line = element_line(colour = "black"))

p
```


## 4. Impact of fishing activities on marine habitats

### 4.1 Context

We used an experimental data set built by Tauran et al. (2020) to study the impact of fishing dredges and varying fishing pressures on maerl beds, in the bay of Brest (Brittany, France). The study follows a Before-After-Control-Impact design (Stewart-Oaten et al., 1986). Briefly, three control stations were surveyed and compared to five treatment stations characterised by different fishing dredges and pressure levels (Tauran et al., 2020): (1) a clam dredge (CD), 70 to 90 kg, 1.5 m wide, 40 teeth of 11 cm each; (2) a queen scallop dredge (QSD), 120 kg,1.8 m wide, with a blade; and (3) a king scallop dredge (KSD), 190 kg, 1.8 m wide, 18 teeth of 10 cm each every 9 cm.
Pressure levels were measured as the number of dredge tows performed on the zone during the experimental dredging session: 0 (i.e. control), 10, or 30 dredge tows. Samples were collected from April 2016 to April2017. Session 1 was sampled just before the experimental dredging (t0); session 2 at t0 + 1 week; session 3 at t0 + 1 month and session 4 at t0 + 12 months. Nine replicates were sampled for all treatments and sessions with a Smith-McIntyre grab (0.1m2).

Abundance were pooled at the treatment levels (i.e. CTRL1, CTRL2, CTRL3, KSD_10, CD_10, CD_30, QSD_10 and QSD_30; Appendix_D) and log-transformed as initially performed in Tauran et al. (2020). A Bray-Curtis matrix of dissimilarity was computed with the resulting data set including raw data for 250 species at 32 observations (i.e. treatments*surveys) and used for both state- and trajectory-based EQAs.

### 4.2 Loading data
```{r load glenan, echo=T}
data(glenan)
#Showing a first lines /columns subset
head(glenan[,1:6])
```


### 4.3 Data set preparation
```{r, echo=T}

#vector Treatment
Treatment<-glenan$Treatment

#vector Surveys
Surveys<-glenan$Surveys

#log transformation
grab_comp<-log1p(glenan[,-c(251:252)])
ID<-rownames(grab_comp)

#Calculation of Bray Curtis ditance
grab_bc <- vegan::vegdist(grab_comp, method = "bray")
```

### 4.4 State-based Ecological Quality Assessment

```{r, echo=T}
#Definition of the state reference envelope
grab_env <- ID[c(1,9:20,21,25,29)]

#Comparing assessed stations with respect to the state reference envelope
grab_assess <- compareToStateEnvelope(grab_bc, grab_env, m=1.5, distances_to_envelope = TRUE)

grab_assess$Status<-c(ifelse(grab_assess$Q>=0.5,"Inside", "Outside"))

grab_assess$Status[c(1,9:20,21,25,29)]<-"Reference"

grab_assess$Status<- factor(grab_assess$Status, levels = c("Reference","Inside","Outside"))

head(grab_assess)

```

Principal Coordinates Analysis
```{r, echo=TRUE}
pcoa<-pcoa(grab_bc)
pcoa$values
```


Representing the results of Glenan state-based EQSA trough in the two first PCoA dimensions
```{r, echo=TRUE, fig.width=6, fig.height=6}
#Get coordinates of stations in the two first dimensions of the PCoA
PCOA_DIM1_2<-pcoa[["vectors"]][,1:2]
grab_assess$Dim1<-PCOA_DIM1_2[,1]
grab_assess$Dim2<-PCOA_DIM1_2[,2]

#Information about Treatment and Surveys 
grab_assess$Treatment<-Treatment
grab_assess$Surveys<-Surveys


p<-ggplot(grab_assess, aes(x=Dim1, y=Dim2, group=Status)) +
  geom_point(aes(shape=Status, color=Status, size=SquaredDist))+
  scale_shape_manual(values=c(1, 16, 17))+
  scale_color_manual(values=c("#00BFC4", "#00BFC4", "#F8766D"))+
  geom_path(aes(x=Dim1,y=Dim2,group=Treatment),color="grey", arrow = arrow(length = unit(0.03, "cm")))+
  geom_text(grab_assess,mapping=aes(x=Dim1,y=Dim2,label=ID),hjust=-0.3, vjust=-0.3,size=2.5, color="Black")+
  xlab(expression("PCoA1 (13.3%)"))+
  ylab(expression("PCoA2 (9.9%)"))

p<-p+ theme_minimal()+
  theme(
    # Hide some graphical elements
    panel.border = element_blank(),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    axis.line = element_line(colour = "black"))

p
```


Creating a bar plot showing the evolution of the squared distance to the centroid of the state reference envelope during the study period for each treatment
```{r, echo=TRUE, fig.width=7, fig.height=6}
grab_assess$Treatment<-factor(grab_assess$Treatment,c("CTRL1","CTRL2","CTRL3",
                                                      "CD_10","CD_30", 
                                                      "QSD_10","QSD_30",
                                                      "KSD_10"))
grab_assess$Status<-c(ifelse(grab_assess$Q>=0.5,"Inside", "Outside"))
grab_assess$Status<- factor(grab_assess$Status, levels = c("Inside","Outside"))

ggplot(grab_assess, aes(x=Surveys, y=SquaredDist, color=Status, fill=Status)) + 
  geom_bar(stat = "identity",width=0.5)+
  scale_colour_manual(values=c("#00BFC4", "#F8766D"))+
  scale_fill_manual(values=c("#00BFC4", "#F8766D"))+
  scale_y_continuous("Squared distance to the reference envelope")+
  theme_minimal()+
  facet_wrap(~Treatment)+
  theme(axis.text.x = element_text(angle=90))

```

Creating the heatmap showing the evolution of the distance between control and dredged stations during the experimentation
```{r, echo=TRUE, fig.width=6, fig.height=6}
grabbc_sel <- melt(as.matrix(grab_bc),rnames = c("row", "col"))

#selection of the observation of interest (i.e. control stations for heat map row, and dredged stations for heat map column)
grabbc_sel<-grabbc_sel[!grabbc_sel$Var2 %in% c("CTRL1-S1","CTRL2-S1","CTRL3-S1","CTRL4-S1",
                                                "CTRL1-S2","CTRL2-S2","CTRL3-S2","CTRL4-S2",
                                                "CTRL1-S3","CTRL2-S3","CTRL3-S3","CTRL4-S3",
                                                "CTRL1-S4","CTRL2-S4","CTRL3-S4","CTRL4-S4"),]   

grabbc_sel<-grabbc_sel[grabbc_sel$Var1 %in% c("CTRL1-S1","CTRL2-S1","CTRL3-S1","CTRL4-S1",
                                               "CTRL1-S2","CTRL2-S2","CTRL3-S2","CTRL4-S2",
                                               "CTRL1-S3","CTRL2-S3","CTRL3-S3","CTRL4-S3",
                                               "CTRL1-S4","CTRL2-S4","CTRL3-S4","CTRL4-S4"),]

grabbc_sel$Var1<-factor(grabbc_sel$Var1,
                        c("CTRL1-S1","CTRL2-S1","CTRL3-S1","CTRL4-S1",
                          "CTRL1-S2","CTRL2-S2","CTRL3-S2","CTRL4-S2",
                          "CTRL1-S3","CTRL2-S3","CTRL3-S3","CTRL4-S3",
                          "CTRL1-S4","CTRL2-S4","CTRL3-S4","CTRL4-S4"))

grabbc_sel$Var2<-factor(grabbc_sel$Var2,
                        c("KSD_10-S1","CD_10-S1","CD_30-S1","QSD_10-S1","QSD_30-S1",
                          "KSD_10-S2","CD_10-S2","CD_30-S2","QSD_10-S2","QSD_30-S2",
                          "KSD_10-S3","CD_10-S3","CD_30-S3","QSD_10-S3","QSD_30-S3",
                          "KSD_10-S4","CD_10-S4","CD_30-S4","QSD_10-S4","QSD_30-S4"))

ggplot(grabbc_sel, aes(x=Var2, y=Var1, fill=value)) + 
  geom_raster() + 
  scale_fill_viridis_c()+
  theme(axis.text.x=element_text(angle = 90, hjust = 0))
```


### 4.5 Trajectory-based Ecological Quality Assessment
```{r, echo=T}
#Definition of the trajectory reference envelope 
grab_dynenv<-c("CTRL1","CTRL2","CTRL3")

##Comparing assessed trajectories with respect to the trajectory reference envelope
grab_dynassess <- compareToTrajectoryEnvelope(grab_bc,Treatment, grab_dynenv, m=1.5, distances_to_envelope = TRUE)

```

Creating a bar plot showing the squared distance to the centroid of the trajectory reference envelope during the study period for each treatment
```{r, echo=T, fig.height=4, fig.width=7}
grab_dynassess$Treatment<-factor(grab_dynassess$Site,c("CTRL1","CTRL2","CTRL3",
                                                      "CD_10","CD_30", 
                                                      "QSD_10","QSD_30",
                                                      "KSD_10"))
grab_dynassess$Status<-c(ifelse(grab_dynassess$Q>=0.5,"Inside", "Outside"))
grab_dynassess$Status<- factor(grab_dynassess$Status, levels = c("Inside","Outside"))

ggplot(grab_dynassess, aes(x=reorder(Treatment, SquaredDist), y=SquaredDist, color=Status, fill=Status)) + 
  geom_bar(stat = "identity",width=0.5)+
  scale_colour_manual(values=c("#00BFC4", "#F8766D"))+
  scale_fill_manual(values=c("#00BFC4", "#F8766D"))+
  scale_y_continuous("Squared distance to the reference envelope")+
  theme_minimal()+
  theme(axis.text.x = element_text(angle=90))

```

## 5. References

+ Sturbois, A., De Cáceres, M., Bifolchi, A., Bioret, F., Boyé, A., Gauthier, O., Grall, J., Grémare, A., Labrune, C., Robert, A., Schaal, G., Desroy, N. (under review). Ecological Quality Assessment: a general multivariate framework to report the quality of ecosystems and their dynamics with respect to reference conditions.

+ Tauran, A., Dubreuil, J., Guyonnet, B., Grall, J., 2020. Impact of fishing gears and fishing intensities on maerl beds: An experimental approach. Journal of Experimental Marine Biology and Ecology 533, 151472. https://doi.org/10.1016/j.jembe.2020.151472

